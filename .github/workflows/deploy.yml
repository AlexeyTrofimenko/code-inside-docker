name: Deploy

on:
  workflow_dispatch:


jobs:
  build:

    runs-on: ubuntu-latest
    env:
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Clone CodeInside Backend Repository
        run: |
          git clone https://github.com/MagisterFelix/CodeInside
      - name: Make DockerFiles 
        run: |
          cd CodeInside
          echo "
          # pull official base image
          FROM python:3.10-alpine

          # set work directory
          WORKDIR /app

          # set environment variables
          ENV PYTHONDONTWRITEBYTECODE 1
          ENV PYTHONUNBUFFERED 1
          ENV DEBUG 1
          ENV SECRET_KEY $secrets.DJANGO_SECRET_KEY

          # install psycopg2
          RUN apk update \
              && apk add --virtual build-deps gcc python3-dev musl-dev \
              && apk add postgresql-dev \
              && pip install psycopg2 \
              && apk del build-deps \
              && apk add gcc \
              && apk add libc-dev \
              && apk add linux-headers \
              && apk add g++


          # install dependencies
          COPY ./requirements.txt .
          RUN pip install -r requirements.txt

          # copy project
          COPY . .

          # collect static files
          RUN python manage.py collectstatic --noinput

          # add and run as non-root user
          RUN adduser -D myuser
          USER myuser

          # run gunicorn
          CMD gunicorn core.wsgi:application --bind 0.0.0.0:$PORT
          " > Dockerfile
          echo "
          __pycache__
          *.pyc
          venv/
          db.sqlite3" > .dockerignore
      - name: Build Docker 
        run: |
          cd CodeInside
          docker build -t web:latest .
